# Developer Tips

## Generate the OpenMRS Docker Image

The following steps are used to generate the openmrs docker image bundled with
modules required for this project

1.  Setup latest OpenMrs distro locally:

    ```
    mvn openmrs-sdk:setup -DserverId=openmrs-analytics
    ```

2.  Add latest versions of
    [fhir2](https://addons.openmrs.org/show/org.openmrs.module.openmrs-fhir2-module)
    and [atom feed](https://addons.openmrs.org/show/org.openmrs.module.atomfeed)
    modules and ensure everything is running as expected.

3.  Generate docker image setup using openmrs SDK, this step requires you to
    provide openmrs-distro.properties file path of your openmrs instance.

    ```
    mvn openmrs-sdk:build-distro -Ddistro=/{path}/openmrs-distro.properties`
    ```

    A folder named `docker` is generated which contains a Dockerfile and other
    setup files. Example of
    [docker file](https://github.com/jecihjoy/openmrs-docker-sdk/blob/master/web/Dockerfile)
    generated by openmrs-sdk.

4.  Build the docker image:

    ```
    cd openmrs-analytics/web docker build -t
    openmrs/openmrs-reference-application-distro:analytics .
    ```

5.  Push this image to docker hub `docker push
    openmrs/openmrs-reference-application-distro:analytics`

## Debezium development

When working on a feature in the Debezium based pipeline, you can replay old
binlog updates by setting the system properties `database.offsetStorage` and
`database.databaseHistory` to an old version of the history. In other words, you
can start from history/offset pair A, add some events in OpenMRS (e.g., add an
Observation) to create some updates in the binlog. Now if you keep a copy of
original version of A (before the changes) you can reuse it in future runs to
replay the new events with no more interactions with OpenMRS.

## Running end-to-end tests

Parquet tools library is used to inspect parquet files. The jar file has been
included in the project under `/e2e-tests/parquet-tools-1.11.1.jar`

To regenerate this jar file:

1.  Clone [parquet-mr](https://github.com/apache/parquet-mr)
2.  Checkout last released version `git checkout apache-parquet-1.11.1`
3.  [Install](https://github.com/apache/parquet-mr#install-thrift) thrift
    compiler v0.12.0
4.  To build the jar file run `mvn -pl parquet-tools -am clean install -Plocal
    -DskipTests`
    You should be able to see `parquet-tools-1.11.1.jar` inside parquet-tools
    module.
5.  Command usage for parquet tools `java -jar ./parquet-tools-<VERSION>.jar
    <command> my_parquet_file`

    NOTE: Parquet tools will be replaced with parquet cli in the next release
    `apache-parquet-1.12.0`

To run the e2e tests, execute ```sh /e2e-tests/run.sh```

